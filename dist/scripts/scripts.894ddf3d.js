"use strict";angular.module("sketchupApp",["ngFileSaver","ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","leaflet-directive"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/buildings",{templateUrl:"views/buildings.html",controller:"BuildingsCtrl"}).when("/topography",{templateUrl:"views/topography.html",controller:"TopographyCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("sketchupApp").controller("NavbarCtrl",["$scope","$location",function(a,b){a.menus=[{text:"Home",path:"/"},{text:"Buildings",path:"/buildings"}],a.getClass=function(a){return b.path()==a.path?"active":""}}]),angular.module("sketchupApp").controller("MainCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("sketchupApp").controller("BuildingsCtrl",["$scope","$http","$timeout","leafletData","buildings","FileSaver","Blob",function(a,b,c,d,e,f,g){a.map={center:{lat:48.859762,lng:2.3435408,zoom:15},tiles:{url:"http://{s}.tile.osm.org/{z}/{x}/{y}.png",type:"xyz",options:{apikey:"pk.eyJ1IjoiYnVmYW51dm9scyIsImEiOiJLSURpX0pnIn0.2_9NrLz1U9bpwMQBhVk97Q",mapid:"ltempier.ni82p485"}},paths:{}},d.getMap().then(function(b){var c=L.rectangle([[a.map.center.lat+.003,a.map.center.lng+.004],[a.map.center.lat-.003,a.map.center.lng-.004]],{color:"#158CBA",fill:!1});b.addLayer(c),c.editing.enable(),a.rect=c}),a.start=function(){a.loading=!0,d.getMap().then(function(d){function f(b){var d=_.filter(b.elements,function(a){return"node"===a.type}),f=_.filter(b.elements,function(a){return"way"===a.type&&a.tags.building});_.each(f,function(a){var b=a.tags["building:levels"]||2,c=g(a,d),f=_.map(c,function(a){return h(a)});e.add(f,3.5*b)}),a.buildings=e.get(),a.sketchupScript=e.toSketchupScript(),c(function(){a.loading=!1})}function g(a,b){var c=_(b).chain().filter(function(b){return 0<=a.nodes.indexOf(b.id)}).sortBy(function(b){return a.nodes.indexOf(b.id)}).map(function(a){return[a.lon,a.lat]}).value();return c}function h(a){var b=d3.geo.mercator().center([j.lng,j.lat]).translate([0,0]).scale(42e5),c=b(a);return[-c[0],c[1]]}e.init();var i=a.rect.getBounds(),j={lat:(i._northEast.lat+i._southWest.lat)/2,lng:(i._northEast.lng+i._southWest.lng)/2,zoom:d.getZoom()},k=[i._southWest.lat,i._southWest.lng,i._northEast.lat,i._northEast.lng],l="https://overpass-api.de/api/interpreter?data=[out:json];((way("+k.join(",")+")[%22building%22]);(._;node(w);););out;";b.get(l).success(f),a.map.center=_.extend(j)})},a.download=function(){var b=new g([a.sketchupScript],{type:"text/plain;charset=utf-8"}),c={data:b,filename:"sketchup_export.rb"};f.saveAs(c)},a.copy=function(){window.clipboardData&&clipboardData.setData&&clipboardData.setData("text",a.sketchupScript)}}]),angular.module("sketchupApp").controller("TopographyCtrl",["$scope","$http","leafletData","topography",function(a,b,c,d){a.map={center:{lat:48.859762,lng:2.3435408,zoom:15},tiles:{url:"http://api.tiles.mapbox.com/v4/{mapid}/{z}/{x}/{y}.png?access_token={apikey}",type:"xyz",options:{apikey:"pk.eyJ1IjoiYnVmYW51dm9scyIsImEiOiJLSURpX0pnIn0.2_9NrLz1U9bpwMQBhVk97Q",mapid:"ltempier.k4ppao03"}},paths:{}};var e=.003,f=.004;a.$watch("map.center",function(b){1!=a.loading&&(a.map.paths.p0={color:"#158CBA",weight:4,latlngs:[[b.lat+e,b.lng+f],[b.lat-e,b.lng+f],[b.lat-e,b.lng-f],[b.lat+e,b.lng-f],[b.lat+e,b.lng+f]]})},!0),a.start=function(){c.getMap().then(function(a){function b(a){var b=[a.location.F,a.location.A],c=256,d=h,e=d3.geo.mercator().center([g.lng,g.lat]).translate([0,0]).scale(c<<d),f=e(b);return[f[0],f[1],Math.round(10*a.elevation)/10]}d.init();var c=50,g=a.getCenter(),h=a.getZoom(),i=g.lat-e,j=g.lat+e,k=g.lng-f,l=f/c,m=new google.maps.ElevationService;async.eachSeries(_.range(c+1),function(a,e){function f(g){m.getElevationAlongPath(h,function(h,i){console.log("Google data "+Math.round(a/c*100)+"%"),"OK"==i?(_.each(h,function(a){d.add(b(a))}),setTimeout(e,g)):"OVER_QUERY_LIMIT"==i?setTimeout(function(){f(g)},10):e(new Error(i))})}var g=k+a*l,h={path:[new google.maps.LatLng(i,g),new google.maps.LatLng(j,g)],samples:c};f(200)},function(a){})})}}]),angular.module("sketchupApp").factory("buildings",function(){function a(a,b){this.points=a,this.level=_.clone(b)}function b(a){var b=100;return _.map(a,function(a){return Math.round(a*b)/b})}var c;return a.prototype.toSketchupScript=function(a){var c=["ent"+a+" = Sketchup.active_model.entities"];return c.push("main_face"+a+" = ent"+a+".add_face "+_.map(this.points,function(a){return"["+b(a).join(",")+"]"})),c.push("main_face"+a+".reverse! if main_face"+a+".normal.z < 0"),c.push("main_face"+a+".pushpull "+Math.abs(this.level)),c.join(" ;\n")},{init:function(){c=[]},add:function(b,d){var e=new a(b,d);c.push(e)},get:function(){return c},toSketchupScript:function(){var a=[];return _.each(c,function(b,c){a.push(b.toSketchupScript(c))}),a.join("\n")}}}),angular.module("sketchupApp").factory("topography",function(){function a(a){this.x=a[0],this.y=a[1],this.z=a[2]}function b(a,b){this.points=a,this.level=b}function c(a){var b,c=[];return _.each(a,function(d){if(b)for(var e=0;4>e;e++){var f,g;if(_.each(a,function(a){function b(){var b=Math.sqrt(Math.pow(h,2)+Math.pow(i,2));(!f||f>b)&&(f=b,g=a)}if(!(a==d||c.indexOf(a)>0)){var h=d.x-a.x,i=d.y-a.y;0==e&&0>h&&i>0&&b(),1==e&&h>0&&i>0&&b(),2==e&&h>0&&0>i&&b(),3==e&&0>h&&0>i&&b()}}),g){c.push(g);break}}else c.push(d);b=d}),c}var d,e;return{init:function(){d=[]},add:function(b){var b=new a(b);d.push(b)},generateBlocks:function(){var a={};return _.each(d,function(b){a[b.z]?a[b.z].push(b):a[b.z]=[b]}),e=_.map(a,function(a,d){c(a);var e=_.map(a,function(a){return[a.x,a.y]});return new b(e,d)})}}}),angular.module("sketchupApp").directive("threeScene",[function(){return{restrict:"E",replace:!0,template:'<div class="threeScene"></div>',scope:{blocks:"=blocks"},link:function(a,b,c){function d(){i=b.width(),j=b.height(),k=new THREE.WebGLRenderer({antialias:!0,alpha:!0}),k.setClearColor("#F5F5F5",1),k.setSize(i,j),l=new THREE.PerspectiveCamera(90,i/j,.1,1e4),l.position.x=-200,l.position.y=200,l.position.z=0,m=new THREE.TrackballControls(l,k.domElement),m.minDistance=200,m.maxDistance=1e3,m.addEventListener("change",function(){h()}),b[0].appendChild(k.domElement),m.handleResize(),a.$watch("blocks",function(a){a&&(n=new THREE.Scene,n.add(l),_.each(a,e),h())},!0),a.$watch(function(){return[b[0].clientWidth,b[0].clientHeight].join("x")},f)}function e(a){var b=new THREE.Shape;b.moveTo(a.points[a.points.length-1][0],a.points[a.points.length-1][1]),_.each(a.points,function(a){b.lineTo(a[0],a[1])});var c=new THREE.ExtrudeGeometry(b,{amount:a.level,bevelEnabled:!1,material:0,extrudeMaterial:1}),d=new THREE.LineBasicMaterial({color:self.randomColor?randomColor():self.colors.building,linewidth:20,linecap:"round",linejoin:"round"}),e=new THREE.Mesh(c,d);c.computeFaceNormals(),e.rotation.x=-Math.PI/2,e.rotation.z=Math.PI/2,e.castShadow=!0,e.receiveShadow=!0,n.add(e)}function f(){i=b.width(),j=b.height(),l.aspect=i/j,l.updateProjectionMatrix(),k.setSize(i,j),m.handleResize(),h(),console.log(l)}function g(){requestAnimationFrame(g),m.update()}function h(){n&&k.render(n,l)}b.css("width",c.width),b.css("height",c.height);var i,j,k,l,m,n;d(),g()}}}]);